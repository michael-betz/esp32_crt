<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<head>
  <title>esp32_crt</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div style="text-align: center;">
  <h1>üì∫ esp32_crt üì∫</h1>
  <i>A small vector-based screen.</i>
  <b>WS: <span id=connected_status>‚ùå</span></b>
  <div>
    <button onclick="tab('f_tab');">FREQ / DUTY</button>
    <button onclick="window.location.href=settings.htm;">Settings</button>
  </div>
</div>
</body>
<script language="javascript" type="text/javascript">
  var websocket;

  function init() {
    websocket = new WebSocket("ws://192.168.188.171/ws");

    websocket.onopen = function(evt) {
      connected_status.innerHTML = "‚åö";
    };

    websocket.onclose = function(evt) {
      connected_status.innerHTML = "‚ùå";
    };

    websocket.onmessage = function(evt) {
      console.log("dat: " + evt.data);
      dat = JSON.parse(evt.data);
      if ("hello" in dat) {
        MAX_DUTY_PERCENT = dat['MAX_DUTY_PERCENT'];
        sliders["DUTY"][0].max = MAX_DUTY_PERCENT / 100 * 10000;
        MAX_T_ON = dat['MAX_T_ON'];
        BITS_PER_SEC = dat["BITS_PER_SEC"];
        tab('t_tab');

        document.getElementById("song_list").innerHTML = '';  // clear list
        websocket.send("l");  // get names of all midi files

        setInterval(function() {
          websocket.send("i");
        }, 1000);
      } else if ("RSSI" in dat) {
        connected_status.innerHTML = "‚úÖ (" + dat["RSSI"] + "dBm)";
      } else if ("f" in dat) {
        var li = document.createElement("li");
        li.innerText = dat['f'];
        document.getElementById("song_list").appendChild(li);
      }
    };

    websocket.onerror = function(evt) {
      connected_status.innerHTML = "üî• " + evt;
    };
  }

  window.addEventListener("load", init, false);
</script>
